
# Generated by stc version 0.6.0
# date                    : 2016/07/14 16:07:38
# Turbine version         : 0.6.0
# Input filename          : /Users/nick/Documents/repos/BARS/transmission_model/swift_proj/swift/test_sweep.swift
# Output filename         : /Users/nick/Documents/repos/BARS/transmission_model/swift_proj/swift/./swift-t-test_sweep.tic.wkl
# STC home                : /Users/nick/sfw/swift-t-test/stc
# Turbine home            : /Users/nick/sfw/swift-t-test/turbine
# Compiler settings:
# stc.auto-declare              : true
# stc.c_preprocess              : false
# stc.checkpointing             : true
# stc.compiler-debug            : true
# stc.debugging                 : COMMENTS
# stc.ic.output-file            : 
# stc.input_filename            : test_sweep.swift
# stc.log.file                  : 
# stc.log.trace                 : false
# stc.must_pass_wait_vars       : true
# stc.opt.algebra               : true
# stc.opt.array-build           : true
# stc.opt.batch-refcounts       : true
# stc.opt.cancel-refcounts      : true
# stc.opt.constant-fold         : true
# stc.opt.controlflow-fusion    : true
# stc.opt.dataflow-op-inline    : true
# stc.opt.dead-code-elim        : true
# stc.opt.demote-globals        : true
# stc.opt.disable-asserts       : false
# stc.opt.expand-loop-threshold-insts: 256
# stc.opt.expand-loop-threshold-iters: 16
# stc.opt.expand-loops          : false
# stc.opt.finalized-var         : true
# stc.opt.flatten-nested        : true
# stc.opt.full-function-inline  : false
# stc.opt.full-unroll           : false
# stc.opt.function-always-inline-threshold: 5
# stc.opt.function-inline       : true
# stc.opt.function-inline-threshold: 50
# stc.opt.function-signature    : true
# stc.opt.hoist                 : true
# stc.opt.hoist-refcounts       : true
# stc.opt.loop-simplify         : true
# stc.opt.max-iterations        : 10
# stc.opt.merge-refcounts       : true
# stc.opt.piggyback-refcounts   : true
# stc.opt.pipeline              : false
# stc.opt.propagate-aliases     : true
# stc.opt.reorder-insts         : false
# stc.opt.shared-constants      : true
# stc.opt.unroll-loop-threshold-insts: 192
# stc.opt.unroll-loop-threshold-iters: 8
# stc.opt.unroll-loops          : true
# stc.opt.value-number          : true
# stc.opt.wait-coalesce         : true
# stc.output_filename           : ./swift-t-test_sweep.tic.wkl
# stc.preproc.force-cpp         : false
# stc.preproc.force-gcc         : false
# stc.preprocess_only           : false
# stc.profile                   : false
# stc.refcounting               : true
# stc.rpath                     : 
# stc.stc_home                  : /Users/nick/sfw/swift-t-test/stc
# stc.turbine.version           : 0.6.0
# stc.turbine_home              : /Users/nick/sfw/swift-t-test/turbine
# stc.version                   : 0.6.0

# Metadata:

package require turbine 0.6.0
namespace import turbine::*


proc swift:constants {  } {
    turbine::c::log "function:swift:constants"
}


proc swift:main {  } {
    turbine::c::log "function: __entry"
    # Var: $string v:model_dir:1 VALUE_OF [string:model_dir]
    # Var: $string v:props_file:1 VALUE_OF [string:props_file]
    # Var: $string v:t:8 VALUE_OF [string:__t:8]
    # Var: file u:upf test_sweep.swift:19:0
    # Var: file u:trans_model_sh test_sweep.swift:15:0
    # Var: $string v:base_out VALUE_OF [string:base_out]
    # Var: $file v:trans_model_sh VALUE_OF [file:trans_model_sh]
    # Var: $file v:upf VALUE_OF [file:upf]
    # Var: $file v:upf:1 VALUE_OF [file:upf]
    # Var: $string$[int] v:upf_lines VALUE_OF [string[int]:upf_lines]
    lassign [ turbine::make_file_tds [ adlb::multicreate [ list file 1 1 1 ] [ list file 1 1 2 ] ] [ list 0 0 ] ] u:upf u:trans_model_sh
    set tcltmp:init_rc 1
    set v:trans_model_sh [ turbine::create_local_file_ref "" ${tcltmp:init_rc} 0 ]
    turbine::input_file_local v:trans_model_sh "../scripts/trans_model.sh"
    turbine::store_file ${u:trans_model_sh} v:trans_model_sh 1
    set v:model_dir:1 [ turbine::argv_get_impl "md" ]
    set v:props_file:1 [ turbine::argv_get_impl "props" ]
    set v:t:8 [ turbine::argv_get_impl "f" ]
    set tcltmp:init_rc 1
    set v:upf [ turbine::create_local_file_ref "" ${tcltmp:init_rc} 0 ]
    turbine::input_file_local v:upf ${v:t:8}
    turbine::store_file ${u:upf} v:upf 1
    set v:upf:1 [ turbine::retrieve_file ${u:upf} CACHED 1 ]
    set v:upf_lines [ turbine::file_lines_impl ${v:upf:1} ]
    set v:base_out [ eval format [ list "%s/out/output" ${v:model_dir:1} ] ]
    set tcltmp:iters [ dict size ${v:upf_lines} ]
    turbine::file_read_refcount_incr ${u:trans_model_sh} [ expr { ${tcltmp:iters} } ]
    dict for {v:i v:s} ${v:upf_lines} {
        # Var: $string v:out_dir VALUE_OF [string:out_dir]
        set v:out_dir [ eval format [ list "%s_%i" ${v:base_out} ${v:i} ] ]
        set tcltmp:prio [ turbine::get_priority ]
        turbine::set_priority ${tcltmp:prio}
        adlb::spawn 0 [ list make_dir-app-leaf1 ${v:base_out} ${v:i} ${v:model_dir:1} ${v:out_dir} ${v:props_file:1} ${v:s} ${u:trans_model_sh} ]
        turbine::reset_priority
    }
    turbine::decr_local_file_refcount v:trans_model_sh
    turbine::decr_local_file_refcount v:upf
    turbine::file_read_refcount_decr ${u:trans_model_sh} 1
}


proc make_dir-app-leaf1 { v:base_out v:i v:model_dir:1 v:out_dir v:props_file:1 v:s u:trans_model_sh } {
    # Var: $void v:o RENAMED [$void:__v:o] test_sweep.swift:make_dir():11:15
    # Var: file u:out test_sweep.swift:__entry():26:24
    # Var: file u:err test_sweep.swift:__entry():27:24
    # Var: $string v:t:13 VALUE_OF [string:__t:13]
    # Var: $string v:t:15 VALUE_OF [string:__t:15]
    # Var: $string v:param_line:1 VALUE_OF [string:param_line]
    lassign [ turbine::make_file_tds [ adlb::multicreate [ list file 0 1 3 ] [ list file 0 1 4 ] ] [ list 1 1 ] ] u:out u:err
    turbine::c::log [ list exec: "mkdir" "-p" ${v:out_dir} [ dict create ] ]
    turbine::exec_external "mkdir" [ dict create ] "-p" ${v:out_dir}
    set v:t:13 "${v:out_dir}/out.txt"
    turbine::set_filename_val ${u:out} ${v:t:13}
    set v:t:15 "${v:out_dir}/err.txt"
    turbine::set_filename_val ${u:err} ${v:t:15}
    set v:param_line:1 [ eval format [ list "run.number=%i,output.directory=%s,%s" ${v:i} ${v:base_out} ${v:s} ] ]
    set tcltmp:prio [ turbine::get_priority ]
    turbine::set_priority ${tcltmp:prio}
    adlb::spawn 0 [ list trans_model-app-leaf1 ${v:model_dir:1} ${v:param_line:1} ${v:props_file:1} ${v:t:13} ${v:t:15} ${u:err} ${u:out} ${u:trans_model_sh} ]
    turbine::reset_priority
}


proc trans_model-app-leaf1 { v:model_dir:1 v:param_line:1 v:props_file:1 v:t:13 v:t:15 u:err u:out u:trans_model_sh } {
    # Var: $file v:shfile RENAMED [$file:__v:shfile] test_sweep.swift:trans_model():7:70
    # Var: $file v:out RENAMED [$file:__v:out] test_sweep.swift:trans_model():7:70
    # Var: $file v:err RENAMED [$file:__v:err] test_sweep.swift:trans_model():7:70
    set v:shfile [ turbine::retrieve_file ${u:trans_model_sh} CACHED 1 ]
    set tcltmp:init_rc 2
    set v:out [ turbine::create_local_file_ref ${v:t:13} ${tcltmp:init_rc} 1 ]
    set tcltmp:init_rc 2
    set v:err [ turbine::create_local_file_ref ${v:t:15} ${tcltmp:init_rc} 1 ]
    turbine::c::log [ list exec: "bash" "../scripts/trans_model.sh" ${v:model_dir:1} ${v:props_file:1} ${v:param_line:1} [ dict create "stdout" ${v:t:13} "stderr" ${v:t:15} ] ]
    turbine::exec_external "bash" [ dict create "stdout" ${v:t:13} "stderr" ${v:t:15} ] "../scripts/trans_model.sh" ${v:model_dir:1} ${v:props_file:1} ${v:param_line:1}
    turbine::store_file ${u:out} v:out 0
    turbine::store_file ${u:err} v:err 0
    turbine::decr_local_file_refcount v:out
    turbine::decr_local_file_refcount v:err
}

turbine::defaults
turbine::declare_custom_work_types COASTER
turbine::init $servers "Swift"
turbine::enable_read_refcount
adlb::declare_struct_type 16 s:location [ list "rank" integer "strictness" string "accuracy" string ]
turbine::check_constants "WORKER\[WORKER\]" ${turbine::WORK_TASK} 0 "CONTROL" ${turbine::WORK_TASK} 0 "ADLB_RANK_ANY" ${adlb::RANK_ANY} -100
adlb::add_debug_symbol 1 "upf" "test_sweep:19:0"
adlb::add_debug_symbol 2 "trans_model_sh" "test_sweep:15:0"
adlb::add_debug_symbol 3 "out" "test_sweep:__entry():26:24"
adlb::add_debug_symbol 4 "err" "test_sweep:__entry():27:24"
turbine::start swift:main swift:constants
turbine::finalize
